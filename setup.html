<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Converted on 2025-04-07 03:30 CDT -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McNabb Family Tree Converter</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background-color: #f0f0f0;
            white-space: pre-wrap;
            font-size: 14px;
        }
        h2 {
            text-align: center;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <h2>McNabb Family Tree Converted Output</h2>
    <div id="output">Converting tree, please wait...</div>

    <script>
        async function convertTree() {
            try {
                const url = 'https://pduke.github.io/mcnabb.fanclub.rocks/mchtml/McNabb%20Tree.html?' + new Date().getTime();
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) throw new Error(`Failed to fetch tree: ${response.status}`);
                const htmlText = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const listItems = doc.querySelectorAll('.tree li');

                if (!listItems.length) throw new Error('No <li> entries found in HTML');

                const peopleMap = new Map(); // Dedupe by name + dob

                function processItem(item) {
                    let text;
                    const summary = item.querySelector('summary');
                    if (summary) {
                        text = summary.textContent.trim().replace(/\s+/g, ' ');
                    } else {
                        text = item.textContent.trim().replace(/\s+/g, ' ');
                    }

                    const heartIndex = text.indexOf('♥');
                    const personText = heartIndex > -1 ? text.substring(0, heartIndex).trim() : text;

                    let name = personText.replace(/\s*\((?:b|d|m)\.(?:abt\s)?[^)]+\)/g, '').trim();
                    const bornMatch = personText.match(/\((b\.(?:abt\s)?[^)]+)\)/) || personText.match(/b\.(abt\s)?(\d{4})/);
                    const diedMatch = personText.match(/\((d\.(?:abt\s)?[^)]+)\)/) || personText.match(/d\.(abt\s)?(\d{4})/);
                    const dobYearMatch = bornMatch && bornMatch[1] ? bornMatch[1].match(/(?:abt\s)?(\d{4})/) : (bornMatch && bornMatch[2] ? [null, bornMatch[2]] : null);
                    const dodYearMatch = diedMatch && diedMatch[1] ? diedMatch[1].match(/(?:abt\s)?(\d{4})/) : (diedMatch && diedMatch[2] ? [null, diedMatch[2]] : null);
                    const dobYear = dobYearMatch ? dobYearMatch[1] : '';
                    const dodYear = dodYearMatch ? dodYearMatch[1] : '';

                    const key = `${name}\t${dobYear}`;

                    let spouses = [];
                    if (heartIndex > -1) {
                        const spouseText = text.substring(heartIndex + 1).trim();
                        const spouseEntries = spouseText.split(/,\s*(?=[A-Za-z][^♥]*\s+(?:b\.|d\.))/);
                        spouses = spouseEntries.map(spouse => {
                            const diedMatch = spouse.match(/\((d\.(?:abt\s)?[^)]+)\)/) || spouse.match(/d\.(abt\s)?(\d{4})/);
                            const bornMatch = spouse.match(/\((b\.(?:abt\s)?[^)]+)\)/) || spouse.match(/b\.(abt\s)?(\d{4})/);
                            const sDiedYearMatch = diedMatch && diedMatch[1] ? diedMatch[1].match(/(?:abt\s)?(\d{4})/) : (diedMatch && diedMatch[2] ? [null, diedMatch[2]] : null);
                            const sBornYearMatch = bornMatch && bornMatch[1] ? bornMatch[1].match(/(?:abt\s)?(\d{4})/) : (bornMatch && bornMatch[2] ? [null, bornMatch[2]] : null);
                            const sDiedYear = sDiedYearMatch ? sDiedYearMatch[1] : '';
                            const sBornYear = sBornYearMatch ? sBornYearMatch[1] : '';
                            let sName = spouse.replace(/\s*\((?:b|d|m)\.(?:abt\s)?[^)]+\)/g, '').trim();
                            return {
                                name: sName,
                                born: sBornYear,
                                died: sDiedYear
                            };
                        });
                    }

                    if (!peopleMap.has(key)) {
                        peopleMap.set(key, {
                            name,
                            dob: dobYear,
                            dod: dodYear,
                            spousename: spouses[0]?.name || '',
                            spousedob: spouses[0]?.born || '',
                            spousedod: spouses[0]?.died || '',
                            source: text
                        });
                    } else if (spouses.length > 0) {
                        const existing = peopleMap.get(key);
                        if (!existing.spousename) {
                            peopleMap.set(key, {
                                name,
                                dob: dobYear,
                                dod: dodYear,
                                spousename: spouses[0]?.name || '',
                                spousedob: spouses[0]?.born || '',
                                spousedod: spouses[0]?.died || '',
                                source: text
                            });
                        } else if (spouses.length > 1 && existing.spousename !== spouses[1]?.name) {
                            const newKey = `${key}\t${spouses[1]?.name || ''}`;
                            peopleMap.set(newKey, {
                                name,
                                dob: dobYear,
                                dod: dodYear,
                                spousename: spouses[1]?.name || '',
                                spousedob: spouses[1]?.born || '',
                                spousedod: spouses[1]?.died || '',
                                source: text
                            });
                        }
                    }

                    const childrenUl = item.querySelector('ul');
                    if (childrenUl) {
                        const childItems = childrenUl.querySelectorAll(':scope > li');
                        childItems.forEach(child => {
                            const childText = child.querySelector('summary') ? child.querySelector('summary').textContent.trim().replace(/\s+/g, ' ') : child.textContent.trim().replace(/\s+/g, ' ');
                            const childName = childText.replace(/\s*\((?:b|d|m)\.(?:abt\s)?[^)]+\)/g, '').trim();
                            const childBornMatch = childText.match(/\((b\.(?:abt\s)?[^)]+)\)/) || childText.match(/b\.(abt\s)?(\d{4})/);
                            const childDiedMatch = childText.match(/\((d\.(?:abt\s)?[^)]+)\)/) || childText.match(/d\.(abt\s)?(\d{4})/);
                            const childDobYearMatch = childBornMatch && childBornMatch[1] ? childBornMatch[1].match(/(?:abt\s)?(\d{4})/) : (childBornMatch && childBornMatch[2] ? [null, childBornMatch[2]] : null);
                            const childDodYearMatch = childDiedMatch && childDiedMatch[1] ? childDiedMatch[1].match(/(?:abt\s)?(\d{4})/) : (childDiedMatch && childDiedMatch[2] ? [null, childDiedMatch[2]] : null);
                            const childDobYear = childDobYearMatch ? childDobYearMatch[1] : '';
                            const childDodYear = childDodYearMatch ? childDodYearMatch[1] : '';
                            const childKey = `${childName}\t${childDobYear}`;
                            if (!peopleMap.has(childKey)) {
                                peopleMap.set(childKey, {
                                    name: childName,
                                    dob: childDobYear,
                                    dod: childDodYear,
                                    spousename: '',
                                    spousedob: '',
                                    spousedod: '',
                                    source: childText
                                });
                            }
                        });
                    }
                }

                listItems.forEach(item => processItem(item));

                const people = Array.from(peopleMap.values());
                const output = "name\tdob\tdod\tspousename\tspousedob\tspousedod\tsource\n" +
                    people.map(p => `${p.name}\t${p.dob}\t${p.dod}\t${p.spousename}\t${p.spousedob}\t${p.spousedod}\t${p.source}`).join('\n');
                document.getElementById('output').textContent = output;

            } catch (err) {
                document.getElementById('output').textContent = `Error: ${err.message}`;
            }
        }

        convertTree();
    </script>
</body>
</html>
