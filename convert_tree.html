<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Converted on 2025-04-07 00:15 CDT -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McNabb Family Tree Converter</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background-color: #f0f0f0;
            white-space: pre-wrap;
            font-size: 14px;
        }
        h2 {
            text-align: center;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <h2>McNabb Family Tree Converted Output</h2>
    <div id="output">Converting tree, please wait...</div>

    <script>
        async function convertTree() {
            try {
                const url = 'https://pduke.github.io/mcnabb.fanclub.rocks/mchtml/McNabb%20Tree.html?' + new Date().getTime();
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) throw new Error(`Failed to fetch tree: ${response.status}`);
                const htmlText = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const listItems = doc.querySelectorAll('.tree li');

                if (!listItems.length) throw new Error('No <li> entries found in HTML');

                const people = [];
                const parentStack = [];

                function processItem(item, currentLevel) {
                    let text;
                    const summary = item.querySelector('summary');
                    if (summary) {
                        text = summary.textContent.trim().replace(/\s+/g, ' ');
                    } else {
                        text = item.textContent.trim().replace(/\s+/g, ' ');
                    }

                    const heartIndex = text.indexOf('â™¥');
                    const personText = heartIndex > -1 ? text.substring(0, heartIndex).trim() : text;

                    let name = personText.split(/ b\.\(?/)[0].trim();
                    const bornMatch = personText.match(/b\.\(([^)]+)\)/) || personText.match(/b\.(\d{4})/);
                    const diedMatch = personText.match(/d\.\(([^)]+)\)/) || personText.match(/d\.(\d{4})/);
                    const marriedMatch = personText.match(/m\.\(([^)]+)\)/) || personText.match(/m\.(\d{4})/);
                    const yearBorn = bornMatch ? (bornMatch[1].includes(' ') ? bornMatch[1] : bornMatch[1]) : '';
                    const yearDied = diedMatch ? (diedMatch[1].includes(' ') ? diedMatch[1] : diedMatch[1]) : '';
                    let yearMarried = marriedMatch ? (marriedMatch[1].includes(' ') ? marriedMatch[1] : marriedMatch[1]) : '';

                    let spouses = [];
                    if (heartIndex > -1) {
                        const spouseText = text.substring(heartIndex + 1).trim();
                        const spouseEntries = spouseText.split(/,\s*(?=[A-Za-z]+\s+(?:b\.|d\.))/);
                        spouses = spouseEntries.map(spouse => {
                            const diedMatch = spouse.match(/d\.\(([^)]+)\)/) || spouse.match(/d\.(\d{4})/);
                            const bornMatch = spouse.match(/b\.\(([^)]+)\)/) || spouse.match(/b\.(\d{4})/);
                            const marriedMatch = spouse.match(/m\.\(([^)]+)\)/) || spouse.match(/m\.(\d{4})/);
                            const sDied = diedMatch ? (diedMatch[1].includes(' ') ? diedMatch[1] : diedMatch[1]) : '';
                            const sBorn = bornMatch ? (bornMatch[1].includes(' ') ? bornMatch[1] : bornMatch[1]) : '';
                            const sMarried = marriedMatch ? (marriedMatch[1].includes(' ') ? marriedMatch[1] : marriedMatch[1]) : '';
                            let sName = spouse;
                            if (diedMatch) sName = sName.replace(/d\.\([^)]+\)|d\.\d{4}/, '').trim();
                            if (bornMatch) sName = sName.replace(/b\.\([^)]+\)|b\.\d{4}/, '').trim();
                            if (marriedMatch) sName = sName.replace(/m\.\([^)]+\)|m\.\d{4}/, '').trim();
                            sName = sName.trim();
                            return {
                                name: sName,
                                born: sBorn,
                                died: sDied,
                                married: sMarried
                            };
                        });
                        if (!yearMarried && spouses[0]?.married) yearMarried = spouses[0].married;
                    }

                    const parent = parentStack.length > 0 ? parentStack[parentStack.length - 1] : { name: '', born: '', died: '' };

                    people.push({
                        name,
                        yearBorn,
                        yearDied,
                        yearMarried: spouses[0]?.married || yearMarried || '',
                        spouseName: spouses[0]?.name || '',
                        spouseBorn: spouses[0]?.born || '',
                        spouseDied: spouses[0]?.died || '',
                        parentName: parent.name,
                        parentBorn: parent.born,
                        parentDied: parent.died
                    });

                    if (spouses.length > 1) {
                        spouses.slice(1).forEach(spouse => {
                            people.push({
                                name,
                                yearBorn,
                                yearDied,
                                yearMarried: spouse.married || '',
                                spouseName: spouse.name,
                                spouseBorn: spouse.born || '',
                                spouseDied: spouse.died || '',
                                parentName: parent.name,
                                parentBorn: parent.born,
                                parentDied: parent.died
                            });
                        });
                    }

                    const childrenUl = item.querySelector('ul');
                    if (childrenUl) {
                        parentStack.push({ name, born: yearBorn, died: yearDied });
                        const childItems = childrenUl.querySelectorAll(':scope > li');
                        childItems.forEach(child => processItem(child, currentLevel + 1));
                        parentStack.pop();
                    }
                }

                listItems.forEach(item => processItem(item, 0));

                const output = "name\tyearborn\tyeardied\tyearmarried\tspouse name\tborn\tdied\tparent name\tborn\tdied\n" +
                    people.map(p => `${p.name}\t${p.yearBorn}\t${p.yearDied}\t${p.yearMarried}\t${p.spouseName}\t${p.spouseBorn}\t${p.spouseDied}\t${p.parentName}\t${p.parentBorn}\t${p.parentDied}`).join('\n');
                document.getElementById('output').textContent = output;

            } catch (err) {
                document.getElementById('output').textContent = `Error: ${err.message}`;
            }
        }

        convertTree();
    </script>
</body>
</html>
